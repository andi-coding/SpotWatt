name = "spotwatt-prices"
main = "src/index.js"
compatibility_date = "2024-01-17"

# wrangler.toml (wrangler v3.88.0^)
[observability.logs]
enabled = true

# Environment variables
[vars]
# Secrets (hinzufügen mit npx wrangler secret put <NAME>):
# - ENTSOE_API_TOKEN: ENTSO-E API Token für Preis-Daten
# - FIREBASE_API_KEY: API Key für Firebase Functions Auth (REQUIRED!)
# - ADMIN_API_KEY: Admin Key für Test-Endpoints
#
# Optional:
# - FIREBASE_FUNCTION_URL: Override default Firebase Function URL
# - CLOUDFLARE_ZONE_ID: Zone ID für Cache Purge API
# - CLOUDFLARE_API_TOKEN: API Token mit "Cache Purge" Permission
#
# Legacy (wird entfernt):
# - FIREBASE_SERVICE_ACCOUNT_KEY: Alte FCM Push Methode (deprecated)

# KV Namespace für Caching
# Erstellen mit: npx wrangler kv:namespace create "PRICE_CACHE"
# Dann die generierte ID hier eintragen
[[kv_namespaces]]
binding = "PRICE_CACHE"
id = "51ae355e5c7749e1915440c1337170d8"

# D1 Database für Provider-Daten (Energy Providers, Tax Rates)
[[d1_databases]]
binding = "DATA_DB"
database_name = "spotwatt-data"
database_id = "b1e2ec5c-adf1-4bba-81a9-10d71996943c"

# Cron Triggers - ENTSO-E publiziert Day-Ahead Preise täglich ~13:00 Lokalzeit
# Optimiert für Sommerzeit (CEST): Erster Versuch 13:50 CEST
# Winterzeit (CET): Erster Versuch wird im Code abgebrochen (zu früh)
# Max 5 Trigger (Cloudflare Free Plan Limit)
[triggers]
crons = [
  "50 11 * * *",  # 11:50 UTC = 12:50 CET / 13:50 CEST (Sommer: OK, Winter: zu früh → skip)
  "50 12 * * *",  # 12:50 UTC = 13:50 CET / 14:50 CEST (60min später)
  "20 13 * * *",  # 13:20 UTC = 14:20 CET / 15:20 CEST (30min später)
  "50 13 * * *",  # 13:50 UTC = 14:50 CET / 15:50 CEST (30min später)
  "20 14 * * *"   # 14:20 UTC = 15:20 CET / 16:20 CEST (30min später, letzter Versuch)
]